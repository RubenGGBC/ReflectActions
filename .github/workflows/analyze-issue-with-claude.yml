name: Analyze Issue with Claude API

on:
  issues:
    types: [opened, edited]

jobs:
  analyze-issue:
    runs-on: ubuntu-latest

    # Solo procesar issues que sean bugs o problemas de UI
    if: contains(github.event.issue.labels.*.name, 'bug') || contains(github.event.issue.labels.*.name, 'UI') || contains(github.event.issue.title, 'bug') || contains(github.event.issue.title, 'UI')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue information
        id: issue_data
        run: |
          # Extraer informaciÃ³n del issue
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"

          # Guardar en variables de entorno para el siguiente paso
          echo "issue_title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "issue_body=${ISSUE_BODY}" >> $GITHUB_OUTPUT
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "issue_author=${ISSUE_AUTHOR}" >> $GITHUB_OUTPUT

      - name: Analyze with Claude API
        id: claude_analysis
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          from urllib.parse import quote

          api_key = os.getenv('CLAUDE_API_KEY')
          issue_title = """${{ steps.issue_data.outputs.issue_title }}"""
          issue_body = """${{ steps.issue_data.outputs.issue_body }}"""

          # Preparar el prompt para Claude
          prompt = f"""Analiza el siguiente issue de una aplicaciÃ³n Flutter (ReflectFlutter - app de reflexiÃ³n zen):

TÃTULO: {issue_title}

DESCRIPCIÃ“N:
{issue_body}

Por favor proporciona:
1. **Resumen del problema**: Â¿CuÃ¡l es el problema exacto?
2. **Causa probable**: Â¿QuÃ© podrÃ­a estar causÃ¡ndolo?
3. **Pasos para reproducir**: Â¿CÃ³mo se puede reproducir el problema?
4. **Soluciones sugeridas**: Â¿QuÃ© cambios de cÃ³digo podrÃ­an resolver esto?
5. **Archivos probablemente afectados**: Â¿QuÃ© archivos del proyecto estÃ¡n relacionados?
6. **Prioridad**: Asigna una prioridad (Alta/Media/Baja)

Responde en formato markdown y sÃ© conciso."""

          # Llamar a Claude API
          headers = {
              "x-api-key": api_key,
              "anthropic-version": "2023-06-01",
              "content-type": "application/json"
          }

          data = {
              "model": "claude-3-5-sonnet-20241022",
              "max_tokens": 1024,
              "messages": [
                  {
                      "role": "user",
                      "content": prompt
                  }
              ]
          }

          try:
              response = requests.post(
                  "https://api.anthropic.com/v1/messages",
                  headers=headers,
                  json=data
              )
              response.raise_for_status()

              result = response.json()
              analysis = result['content'][0]['text']

              # Guardar el anÃ¡lisis
              with open('claude_analysis.txt', 'w') as f:
                  f.write(analysis)

              print("âœ… AnÃ¡lisis completado exitosamente")
              print(analysis)

          except requests.exceptions.RequestException as e:
              print(f"âŒ Error al llamar a Claude API: {e}")
              exit(1)
          EOF

      - name: Post comment on issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('claude_analysis.txt', 'utf8');

            const comment = `## ðŸ¤– AnÃ¡lisis AutomÃ¡tico con Claude AI

            ${analysis}

            ---
            *Este anÃ¡lisis fue generado automÃ¡ticamente por Claude AI. Por favor verifica la informaciÃ³n antes de actuar.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            console.log('âœ… Comentario publicado en el issue');

      - name: Add labels based on analysis
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('claude_analysis.txt', 'utf8').toLowerCase();

            const labels = [];

            // Detectar prioridad
            if (analysis.includes('alta') || analysis.includes('crÃ­tico')) {
              labels.push('priority-high');
            } else if (analysis.includes('media')) {
              labels.push('priority-medium');
            } else if (analysis.includes('baja')) {
              labels.push('priority-low');
            }

            // Detectar tipo de problema
            if (analysis.includes('ui') || analysis.includes('interfaz')) {
              labels.push('ui-problem');
            }
            if (analysis.includes('rendimiento') || analysis.includes('performance')) {
              labels.push('performance');
            }
            if (analysis.includes('crash') || analysis.includes('error')) {
              labels.push('crash');
            }

            if (labels.length > 0) {
              github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });

              console.log('âœ… Labels aÃ±adidos:', labels);
            }
