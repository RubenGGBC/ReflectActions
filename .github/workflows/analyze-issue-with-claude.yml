name: Analyze Issue with Gemini API

on:
  issues:
    types: [opened, edited]

jobs:
  analyze-issue:
    runs-on: ubuntu-latest

    if: contains(github.event.issue.title, 'bug') || contains(github.event.issue.title, 'Bug') || contains(github.event.issue.title, 'UI') || contains(github.event.issue.body, 'bug') || contains(github.event.issue.body, 'Bug') || contains(github.event.issue.body, 'UI')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyze with Google Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          curl -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "contents": [{
                "parts": [{
                  "text": "Analiza el siguiente issue de una aplicaci칩n Flutter (ReflectFlutter):\n\nT칈TULO: '"$ISSUE_TITLE"'\n\nDESCRIPCI칍N:\n'"$ISSUE_BODY"'\n\nPor favor proporciona:\n1. Resumen del problema\n2. Causa probable\n3. Pasos para reproducir\n4. Soluciones sugeridas\n5. Archivos probablemente afectados\n6. Prioridad (Alta/Media/Baja)\n\nResponde en formato markdown."
                }]
              }]
            }' | jq -r '.candidates[0].content.parts[0].text' > analysis.txt
          cat analysis.txt

      - name: Post Analysis Comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let analysis = 'No analysis available';
            try {
              analysis = fs.readFileSync('analysis.txt', 'utf8');
            } catch (e) {
              console.log('Could not read analysis');
            }

            const comment = `## 游뱄 An치lisis Autom치tico con Claude AI\n\n${analysis}\n\n---\n*An치lisis generado autom치ticamente por Claude AI*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Add Priority Labels
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let analysis = '';
            try {
              analysis = fs.readFileSync('analysis.txt', 'utf8').toLowerCase();
            } catch (e) {
              return;
            }

            const labels = [];

            if (analysis.includes('alta') || analysis.includes('critico')) {
              labels.push('priority-high');
            } else if (analysis.includes('media')) {
              labels.push('priority-medium');
            } else if (analysis.includes('baja')) {
              labels.push('priority-low');
            }

            if (analysis.includes('ui') || analysis.includes('visual')) {
              labels.push('ui-problem');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            }
